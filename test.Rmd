---
title: "do_ _px Dataset on Greenlandic Life tables, v7"
author: "Lars Pedersen, Statistics Greenland"
date: "`r format(Sys.time(), '%d. %B %Y')`"
output: html_document
---

```{r setup, include=TRUE}

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

```{r pgm}

## Packages -----------------------------------------------------

# CRAN
library(pxR)
library(tidyverse)
# library(writexl)
library(readxl)

# non-CRAN
# https://github.com/StatisticsGreenland/statgl
# library(statgl)


## Local Paths ------------------------------------------------------

doPxDir     <- file.path("DO_PX")
workPath    <- file.path(doPxDir, "tmp")
dataPath    <- file.path(doPxDir, "datasaet")
pgmPath     <- file.path(doPxDir, "pgm")
resultsPath <- file.path(doPxDir, "results")
metaPath    <- file.path(doPxDir, "metadata")

# general get metadata for one variable from statbank
source(file.path(pgmPath, "getMetaFromStatbank.R"))

# write multilingual px file (based on pxR)
source(file.path(pgmPath, "writepx.R"))


```


### DO_PX

Udgangspunkt er et tidy dataset 'px_data' som indlæses fra dataPath.

Metadata til px-fil hentes fra xlsx-fil på metaPath. xlsx-fil er i vores interne standard til at håndtere metadata (oversættelse) mm  


px- filer kan editeres med pxedit (og pxjob). Program findes hos statFin  
https://www.stat.fi/tup/tilastotietokannat/px-tuoteperhe_en.html

px-filer kan vises med pxwin (windows-program) eller som i vores Statistikbank med pxweb  
https://www.scb.se/en/services/statistical-programs-for-px-files/


px format beskrivelse ses her:  
https://www.scb.se/en/services/statistical-programs-for-px-files/px-file-format/

```{r PX_file, fig.asp = 0.7, fig.width = 4, out.width = "60%", echo=FALSE, message=FALSE, warning=FALSE, collapse=TRUE}


#*********************************
#
# languages in px-file, PXMATRIX
#
#*********************************


# PXMATRIX bruges som tabel ident. Både som filnavn med filtype .px og som MATRIX-nøgleord i fil
PXMATRIX <- "BEXLTALL"

# px-fil skal dannes med 3 sprog (en - engelsk, da - dansk og kl - grønlandsk)
langs <- c("en", "da", "kl") 


#*********************************
# read data from local copy of px_data_lt
#*********************************

px_data <- read_rds(file.path(dataPath,"px_data_lt.Rds")) 

px_data_tmp <- px_data |> filter(time >=2015)

#*********************************

#*******************************************************
#
# the dataset px_data has these variables:
# 
# time, pob, nop, age, gender, calcbase, measure, value
#
# Metadata is found in meta_<%PXMATRIX%>_Modified.xlsx
#
# If Modified file is NOT found DO a metadata-draft and save in metaPath as meta_<%PXMATRIX%>.xlsx
#
# The format is identical to the format used by 
# internal sas-makro procedures at Statistics Greenland
#
#*******************************************************


# Only if meta_<%PXMATRIX%>_Modified.xlsx is not found in metaPath a new meta-xlsx is created

if(file.exists(file.path(metaPath, glue::glue("meta_{PXMATRIX}_Modified.xlsx")))){
# no need TO DO
} else {
source(file.path(pgmPath,"DO_PX_step1.R"))
}


# getModified xlsx
source(file.path(pgmPath,"getModifiedXLSX.R"))


# to lists

lst_time_filter <- tidy_Variables %>% 
  filter(toupper(type)=="TIME") %>% 
  distinct(VarName, lang, lVarName)

lst_time <- px_data_tmp %>% 
#  filter(lst_time_filter) %>% 
  distinct(time) %>% 
  mutate(
    code = glue::glue('"{time}"'),
    value = glue::glue('"{time}"')
  ) %>% 
    group_by(time) %>%
  nest(bob = time:value) %>%
  mutate(
    list = map(bob, pull, code),
    value = map_chr(list, paste0, collapse = ","),
    VarName="time"
  ) %>% 
  select(VarName,value) %>% 
  left_join(lst_time_filter) %>% 
  select(lVarName,lang, value) %>% 
    mutate(CODES = paste0('CODES[',lang,']("',lVarName,'")'),
         VALUES = paste0('VALUES[',lang,']("',lVarName,'")')) %>% 
    select(VALUES,value) %>% 
  deframe()


lst_CODES <- tidy_Codelists_lang %>% 
  select(CODES, VALUES, code, value) %>%
  mutate(
    code = glue::glue('"{code}"'),
    value = glue::glue('"{value}"')
  ) %>%
  group_by(CODES) %>%
  nest(bob = VALUES:value) %>%
  mutate(
    list = map(bob, pull, code),
    value = map_chr(list, paste0, collapse = ","),
    CODES = CODES %>% str_remove_all("\\[en]")
  ) %>% 
  select(CODES,value) %>% 
  deframe()
  
lst_VALUES <- tidy_Codelists_lang %>% 
  select(CODES, VALUES, code, value) %>%
    mutate(VALUES=across(VALUES,str_replace_all," ",".")) %>%
  mutate(
    code = glue::glue('"{code}"'),
    value = glue::glue('"{value}"')
  ) %>%
  group_by(VALUES) %>%
  nest(bob = c(CODES, code, value)) %>%
  mutate(
    list = map(bob, pull, value),
    value = map_chr(list, paste0, collapse = ","),
    VALUES = VALUES  %>% str_remove_all("\\[en]") 
  )%>% 
  select(VALUES,value) %>% 
  deframe()


lst_General <- tidy_General |> mutate(name = "{keyword}[{lang}]" |> glue::glue() %>% str_remove_all("\\[]")) %>% 
  select(name,value) %>% 
  deframe()

lst_stub <-tidy_Variables %>% 
  filter(position %>% str_detect("s")) %>% 
  arrange(position) %>%
  select(lang, lVarName) %>% 
  mutate(lVarName=across(lVarName,str_replace_all," ",".")) %>%
  mutate(lang = glue::glue('STUB[{lang}]') %>%
           str_remove_all("\\[en]")) %>% 
    group_by(lang) %>%
  nest(data = lVarName) %>%
  mutate(
    list = map(data, pull, lVarName),
    value = map_chr(list, paste, collapse = "\",\"") %>% 
      str_sub(3,-2)) %>% 
  select(lang,value) %>% 
  deframe()

lst_head <-tidy_Variables %>% 
  filter(position %>% str_detect("h")) %>% 
  arrange(position) %>%
  select(lang, lVarName) %>%
  mutate(lang = glue::glue('HEADING[{lang}]') %>% str_remove_all("\\[en]")) %>% 
  group_by(lang) %>%
  nest(data = lVarName) %>%
  mutate(
    list = map(data, pull, lVarName),
    value = map_chr(list, paste, collapse = "\",\"")) %>% 
  select(lang,value) %>% 
  deframe()

lst_precision <- tidy_precision %>% 
  deframe()

lst_elimination <- tidy_Variables |>
  select(lVarName, lang, lelimination) %>%
    mutate(eli=glue::glue('ELIMINATION[{lang}]("{lVarName}")'),
    eli = eli  %>% str_remove_all("\\[en]") 
  ) %>% 
  select(eli,lelimination) %>% 
  drop_na(lelimination) %>% 
  mutate(lelimination = ifelse(!lelimination %in% c("YES","NO"), paste0('"',lelimination,'"'),lelimination)) %>% 
  deframe()

lst_General_nolang <- tidy_General_noLang %>% 
  deframe()

meta_list <- lst_General_nolang %>% 
  append(lst_General) %>%
  append(lst_stub) %>%
  append(lst_head) %>%
  append(lst_VALUES) %>%
  append(lst_time) %>%
  append(lst_CODES) %>%
  append(lst_elimination) %>% 
  append(lst_precision)

hi <- enframe(meta_list)




VarNames <- tidy_Variables %>% filter(lang=="en") %>% select(lVarName)

# VarNames
# 
# px_data <- read_rds(paste0(dataPath,"px_data_lt.Rds")) 


# px_data <- px_data_tmp %>% select(time,
#                                   measure=measure.code,
#                                   calc.type=calcbase.code,
#                                   gender=gender.code,
#                                   age=age.code,
#                                   no.of.years=nop.code,
#                                   place.of.birth=pob,
#                                   value) %>%
#   filter(!is.infinite(value)) %>% 
#   arrange(time,measure,calc.type,gender,age,no.of.years,place.of.birth)

px_data <- px_data_tmp %>% select(time,
                              place.of.birth=pob,
                              no.of.years=nop.code,
                              age=age.code,
                              gender=gender.code,
                              calc.type=calcbase.code,
                              measure=measure.code,
                              value) %>%
  filter(!is.infinite(value))


px <- px_data |> as.px(list.keys = meta_list)


px[['VALUES']] <- NULL

px$`CREATION-DATE`$value <- format(Sys.time(), "%Y%m%d %H:%M")

px[['TITLE']] <- px$DESCRIPTION
px[['TITLE[da]']] <- px$`DESCRIPTION[da]`
px[['TITLE[kl]']] <- px$`DESCRIPTION[kl]`

px[['LAST-UPDATE']] <- NULL
px$`LAST-UPDATED`$value <- format(Sys.time(), "%Y%m%d %H:%M")  

px[['NEXT-UPDATE']] <- NULL
px$`NEXT-UPDATE`$value <- format(Sys.time(), "%Y%m%d %H:%M") 
px$LANGUAGE$value <- "en"
px$LANGUAGES$value <- langs

px[['DECIMALS']] <- NULL

px$DECIMALS$value <- Mod_General_MD  %>% filter(keyword=="DECIMAL") %>% select(value) %>%  as.character()

px[['SHOWDECIMALS']] <- NULL

px$SHOWDECIMALS$value <- Mod_General_MD  %>% filter(keyword=="SHOWDECIMAL") %>% select(value) %>%  as.character()

px$MATRIX$value <- PXMATRIX

px |> writepx.gs(paste0(resultsPath,"/",px$MATRIX$value,".px"))


```

